#!/usr/bin/env bash
# ============================================================
# ğŸš€ mc-export.sh â€” Build + Export project Minecraft (Termux, rsync progress)
# ============================================================

set -e

run_build=true
project_name=$(basename "$PWD")
project_name=${project_name#mc-}          # hapus prefix mc- jika ada
target_dir="$HOME/storage/downloads/Termux/mc-$project_name"


# --- Parsing argumen ---
while [[ "$#" -gt 0 ]]; do
  case "$1" in
    --no-build)
      run_build=false
      ;;
    --to)
      target_dir="$2"
      shift
      ;;
    *)
      echo "âŒ Argumen tidak dikenal: $1"
      echo "   Gunakan: mc-export [--no-build] [--to <target_dir>]"
      exit 1
      ;;
  esac
  shift
done

echo "ğŸš€ Exporting project: $project_name"
echo "ğŸ“‚ Target: $target_dir"
echo


if [ "$run_build" = true ]; then
  # --- 1ï¸âƒ£ Build TypeScript ---
  echo "ğŸ§¹ Menjalankan TypeScript compiler (tsc)..."
  if ! npx tsc; then
    echo "âŒ Gagal menjalankan tsc"
    exit 1
  fi
  echo "âœ… TypeScript build selesai"
  echo
  
  # --- 2ï¸âƒ£ Jalankan esbuild ---
  echo "âš™ï¸  Menjalankan bundler (esbuild.js)..."
  if ! node esbuild.js; then
    echo "âŒ Gagal menjalankan esbuild"
    exit 1
  fi
  echo "âœ… Bundling selesai"
  echo
fi

# --- 3ï¸âƒ£ Sync ke target ---
echo "ğŸ“¦ Menyalin hasil ke target:"
echo "    $target_dir"
echo

mkdir -p "$target_dir"

rsync -avh --delete --info=progress2 \
  --exclude 'node_modules' \
  --exclude '.git' \
  --exclude '.env' \
  --exclude '*.log' \
  ./ "$target_dir/"

echo
echo "ğŸ‰ Export selesai: $target_dir"
termux-toast "Export project $project_name selesai!"
